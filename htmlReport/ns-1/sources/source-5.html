


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > OrderDto</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.increff.posapp.dto</a>
</div>

<h1>Coverage Summary for Class: OrderDto (com.increff.posapp.dto)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">OrderDto</td>
<td class="coverageStat">
  <span class="percent">
    10%
  </span>
  <span class="absValue">
    (1/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1%
  </span>
  <span class="absValue">
    (1/102)
  </span>
</td>
</tr>
  <tr>
    <td class="name">OrderDto$$EnhancerBySpringCGLIB$$44e14a22</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    10%
  </span>
  <span class="absValue">
    (1/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    1%
  </span>
  <span class="absValue">
    (1/102)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.increff.posapp.dto;
&nbsp;
&nbsp;import com.increff.invoiceapp.base64encoder.PdfService;
&nbsp;import com.increff.posapp.model.OrderData;
&nbsp;import com.increff.posapp.model.OrderForm;
&nbsp;import com.increff.posapp.model.OrderItemData;
&nbsp;import com.increff.posapp.pojo.InventoryPojo;
&nbsp;import com.increff.posapp.pojo.OrderItemPojo;
&nbsp;import com.increff.posapp.pojo.OrderPojo;
&nbsp;import com.increff.posapp.pojo.ProductPojo;
&nbsp;import com.increff.posapp.service.*;
&nbsp;import com.increff.posapp.util.Converter;
&nbsp;import com.increff.posapp.util.DateTimeUtil;
&nbsp;import com.increff.posapp.util.Normalizer;
&nbsp;import com.increff.posapp.util.Validator;
&nbsp;import org.apache.fop.apps.FOPException;
&nbsp;import org.apache.log4j.Logger;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.data.domain.Page;
&nbsp;import org.springframework.data.domain.PageImpl;
&nbsp;import org.springframework.data.domain.PageRequest;
&nbsp;import org.springframework.stereotype.Component;
&nbsp;
&nbsp;
&nbsp;import javax.servlet.http.HttpServletResponse;
&nbsp;import javax.transaction.Transactional;
&nbsp;import javax.xml.bind.JAXBException;
&nbsp;import javax.xml.transform.TransformerException;
&nbsp;import java.io.IOException;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;import java.util.Base64;
&nbsp;
&nbsp;@Component
<b class="fc">&nbsp;public class OrderDto {</b>
&nbsp;
&nbsp;	@Autowired
&nbsp;	private ProductService productService;
&nbsp;	@Autowired
&nbsp;	private InventoryService inventoryService;
&nbsp;	@Autowired
&nbsp;	private OrderService orderService;
&nbsp;	@Autowired
&nbsp;	private OrderItemService orderItemService;
&nbsp;
&nbsp;
&nbsp;	@Transactional(rollbackOn = ApiException.class)
&nbsp;	public List&lt;OrderItemData&gt; add(OrderForm form) throws ApiException, IllegalAccessException {
<b class="nc">&nbsp;		List&lt;OrderItemData&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		OrderPojo orderPojo = new OrderPojo(&quot;Asia/Kolkata&quot;);</b>
<b class="nc">&nbsp;		orderService.add(orderPojo);</b>
<b class="nc">&nbsp;		Integer len = form.getBarcodes().size();</b>
<b class="nc">&nbsp;		Validator.orderFormValidator(form);</b>
<b class="nc">&nbsp;		for(int i=0; i &lt; len; i++) {</b>
&nbsp;
<b class="nc">&nbsp;			ProductPojo productPojo = productService.getByBarcode(form.getBarcodes().get(i));</b>
<b class="nc">&nbsp;			InventoryPojo inventoryPojo = inventoryService.getByProductId(productPojo.getId());</b>
<b class="nc">&nbsp;			Double mrp = productPojo.getMrp();</b>
<b class="nc">&nbsp;			Integer initialQuantity = inventoryPojo.getQuantity();</b>
&nbsp;
<b class="nc">&nbsp;			validateMrp(form.getSellingPrices().get(i), mrp);</b>
<b class="nc">&nbsp;			validateQuantityRequest(form.getQuantities().get(i), initialQuantity);</b>
&nbsp;
<b class="nc">&nbsp;			Integer finalQuantity = initialQuantity - form.getQuantities().get(i);</b>
<b class="nc">&nbsp;			inventoryPojo.setQuantity(finalQuantity);</b>
<b class="nc">&nbsp;			inventoryService.updateByProductId(inventoryPojo);</b>
&nbsp;
<b class="nc">&nbsp;			OrderItemPojo orderItemPojo = Converter.convertToOrderItemPojo(form, i, orderPojo, inventoryPojo.getProductId());</b>
<b class="nc">&nbsp;			list.add(</b>
<b class="nc">&nbsp;					Converter.convertToOrderItemData(</b>
<b class="nc">&nbsp;							orderItemService.add(orderItemPojo),</b>
&nbsp;							productPojo)
&nbsp;			);
&nbsp;		}
<b class="nc">&nbsp;		return list;</b>
&nbsp;	}
&nbsp;
&nbsp;	public List&lt;OrderData&gt; getAll() throws ApiException {
<b class="nc">&nbsp;		List&lt;OrderPojo&gt; list = orderService.getAll();</b>
<b class="nc">&nbsp;		List&lt;OrderData&gt; list2 = new ArrayList&lt;OrderData&gt;();</b>
<b class="nc">&nbsp;		Double totalAmount = 0.0;</b>
<b class="nc">&nbsp;		for (OrderPojo orderPojo : list) {</b>
<b class="nc">&nbsp;			totalAmount = 0.00;</b>
<b class="nc">&nbsp;			for(OrderItemPojo orderItemPojo: orderItemService.getByOrderId(orderPojo.getId())){</b>
<b class="nc">&nbsp;				totalAmount += orderItemPojo.getSellingPrice() * orderItemPojo.getQuantity();</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			list2.add(Converter.convertToOrderData(orderPojo, totalAmount));</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return list2;</b>
&nbsp;	}
&nbsp;
&nbsp;	public Page&lt;OrderData&gt; getAll(Integer page, Integer size) throws ApiException {
<b class="nc">&nbsp;		Validator.isEmpty(&quot;Page&quot;, page);</b>
<b class="nc">&nbsp;		Validator.isEmpty(&quot;Size&quot;, size);</b>
<b class="nc">&nbsp;		Page&lt;OrderPojo&gt; pojoPage = orderService.getAllByPage(page, size);</b>
<b class="nc">&nbsp;		List&lt;OrderPojo&gt; list = pojoPage.getContent();</b>
<b class="nc">&nbsp;		List&lt;OrderData&gt; list2 = new ArrayList&lt;OrderData&gt;();</b>
<b class="nc">&nbsp;		Double totalAmount = 0.0;</b>
<b class="nc">&nbsp;		for (OrderPojo orderPojo : list) {</b>
<b class="nc">&nbsp;			totalAmount = 0.00;</b>
<b class="nc">&nbsp;			for(OrderItemPojo orderItemPojo: orderItemService.getByOrderId(orderPojo.getId())){</b>
<b class="nc">&nbsp;				totalAmount += orderItemPojo.getSellingPrice() * orderItemPojo.getQuantity();</b>
<b class="nc">&nbsp;			}</b>
<b class="nc">&nbsp;			list2.add(Converter.convertToOrderData(orderPojo, totalAmount));</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return new PageImpl&lt;&gt;(list2, PageRequest.of(page, size), pojoPage.getTotalElements());</b>
&nbsp;	}
&nbsp;
&nbsp;	 @Transactional(rollbackOn = ApiException.class)
&nbsp;	 public void convertToPdf(Integer orderId, HttpServletResponse response) throws TransformerException, FOPException, ApiException, IOException, JAXBException {
<b class="nc">&nbsp;		Validator.isEmpty(&quot;Order id&quot;, orderId);</b>
<b class="nc">&nbsp;		List&lt;OrderItemPojo&gt; orderItemPojoList = orderItemService.getByOrderId(orderId);</b>
<b class="nc">&nbsp;		 OrderPojo orderPojo = orderService.getById(orderId);</b>
<b class="nc">&nbsp;		 String date = DateTimeUtil.getDateTimeString(orderPojo.getTime(), &quot;dd/MM/yyyy&quot;);</b>
<b class="nc">&nbsp;		 List&lt;OrderItemData&gt; orderItemDataList = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		 for(OrderItemPojo orderItemPojo:orderItemPojoList){</b>
<b class="nc">&nbsp;			 ProductPojo productPojo = productService.getById(orderItemPojo.getProductId());</b>
<b class="nc">&nbsp;			 orderItemDataList.add(Converter.convertToOrderItemData(orderItemPojo, productPojo));</b>
<b class="nc">&nbsp;		 }</b>
&nbsp;
<b class="nc">&nbsp;		 List&lt;Integer&gt; orderItemsIds = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		 List&lt;String&gt; productNames = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		 List&lt;Integer&gt; quantities = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		 List&lt;String&gt; sellingPrices = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		 List&lt;String&gt; mrps = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		for(OrderItemData orderItemData: orderItemDataList){</b>
<b class="nc">&nbsp;			orderItemsIds.add(orderItemData.getId());</b>
<b class="nc">&nbsp;			productNames.add(orderItemData.getProductName());</b>
<b class="nc">&nbsp;			quantities.add(orderItemData.getQuantity());</b>
<b class="nc">&nbsp;			sellingPrices.add(orderItemData.getSellingPrice());</b>
<b class="nc">&nbsp;			mrps.add(orderItemData.getMrp());</b>
<b class="nc">&nbsp;		}</b>
&nbsp;
&nbsp;		// invoice-app is called
<b class="nc">&nbsp;		String base64EncodedString = PdfService.getBase64String(</b>
&nbsp;				date,
&nbsp;				orderId,
&nbsp;				orderItemsIds,
&nbsp;				productNames,
&nbsp;				quantities,
&nbsp;				sellingPrices,
&nbsp;				mrps
&nbsp;		);
&nbsp;
<b class="nc">&nbsp;		 byte[] decodedBytes = Base64.getDecoder().decode(base64EncodedString);</b>
&nbsp;
<b class="nc">&nbsp;		 response.setContentType(&quot;application/pdf&quot;);</b>
<b class="nc">&nbsp;		 response.setContentLength(decodedBytes.length);</b>
<b class="nc">&nbsp;		 response.getOutputStream().write(decodedBytes);</b>
<b class="nc">&nbsp;		 response.getOutputStream().flush();</b>
&nbsp;	 }
&nbsp;
&nbsp;	public List&lt;OrderItemData&gt; getByOrderId(Integer orderId) throws ApiException {
<b class="nc">&nbsp;		Validator.isEmpty(&quot;Order id&quot;, orderId);</b>
<b class="nc">&nbsp;		List&lt;OrderItemPojo&gt; orderItemPojoList = orderItemService.getByOrderId(orderId);</b>
<b class="nc">&nbsp;		List&lt;OrderItemData&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		for(OrderItemPojo orderItemPojo:orderItemPojoList){</b>
<b class="nc">&nbsp;			ProductPojo productPojo = productService.getById(orderItemPojo.getProductId());</b>
<b class="nc">&nbsp;			list.add(Converter.convertToOrderItemData(orderItemPojo, productPojo));</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return list;</b>
&nbsp;	}
&nbsp;
&nbsp;	public Page&lt;OrderItemData&gt; getPageByOrderId(Integer orderId, Integer page, Integer size) throws ApiException {
<b class="nc">&nbsp;		Validator.isEmpty(&quot;Order id&quot;, orderId);</b>
<b class="nc">&nbsp;		Validator.isEmpty(&quot;Page&quot;, page);</b>
<b class="nc">&nbsp;		Validator.isEmpty(&quot;Size&quot;, size);</b>
<b class="nc">&nbsp;		Page&lt;OrderItemPojo&gt; pojoPage = orderItemService.getPageByOrderId(orderId, page, size);</b>
<b class="nc">&nbsp;		List&lt;OrderItemPojo&gt; orderItemPojoList = pojoPage.getContent();</b>
<b class="nc">&nbsp;		List&lt;OrderItemData&gt; list = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;		for(OrderItemPojo orderItemPojo:orderItemPojoList){</b>
<b class="nc">&nbsp;			ProductPojo productPojo = productService.getById(orderItemPojo.getProductId());</b>
<b class="nc">&nbsp;			list.add(Converter.convertToOrderItemData(orderItemPojo, productPojo));</b>
<b class="nc">&nbsp;		}</b>
<b class="nc">&nbsp;		return new PageImpl&lt;&gt;(</b>
&nbsp;				list,
<b class="nc">&nbsp;				PageRequest.of(page, size),</b>
<b class="nc">&nbsp;				pojoPage.getTotalElements()</b>
&nbsp;		);
&nbsp;	}
&nbsp;
&nbsp;	public OrderItemData getByOrderItemId(Integer id) throws ApiException {
<b class="nc">&nbsp;		Validator.isEmpty(&quot;Id&quot;, id);</b>
<b class="nc">&nbsp;		OrderItemPojo orderItemPojo = orderItemService.getById(id);</b>
<b class="nc">&nbsp;		ProductPojo productPojo = productService.getById(orderItemPojo.getProductId());</b>
<b class="nc">&nbsp;		return Converter.convertToOrderItemData(orderItemPojo, productPojo);</b>
&nbsp;	}
&nbsp;
&nbsp;	private void validateMrp(Double sellingPrice, Double mrp) throws ApiException {
<b class="nc">&nbsp;		if (sellingPrice &gt; mrp) {</b>
<b class="nc">&nbsp;			throw new ApiException(&quot;Selling price must be less than MRP&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;
&nbsp;	private void validateQuantityRequest(Integer requestedQuantity, Integer initialQuantity) throws ApiException {
<b class="nc">&nbsp;		if (initialQuantity &lt; requestedQuantity) {</b>
<b class="nc">&nbsp;			throw new ApiException(&quot;Entered quantity is greater than quantity present in inventory&quot;);</b>
&nbsp;		}
&nbsp;	}
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-02-20 15:35</div>
</div>
</body>
</html>
